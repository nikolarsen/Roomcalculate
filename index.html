<script>
// Telegram WebApp инициализация
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  Telegram.WebApp.setHeaderColor('#000000');
  Telegram.WebApp.setBackgroundColor('#000000');
}

const $ = id => document.getElementById(id);
const roomsEl = $('rooms');
const modalRoot = $('modalRoot');
const calcHistoryEl = $('calcHistory');
const historyListEl = $('historyList');

let calcHistoryData = [];
const calcNum1 = $('calcNum1');
const calcNum2 = $('calcNum2');
const calcResult = $('calcResult');
const opSymbol = $('opSymbol');
const saveCalcBtn = $('saveCalc');
let currentOp = '*';

const opSymbols = { '*': '×', '+': '+', '-': '−', '/': '÷' };

document.querySelectorAll('.calc-op').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.calc-op').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentOp = btn.dataset.op;
    opSymbol.textContent = opSymbols[currentOp];
    calcUpdate();
  };
});

function calcUpdate() {
  const v1 = calcNum1.value.trim(), v2 = calcNum2.value.trim();
  if (!v1 || !v2) return (calcResult.value = '');
  const n1 = parseFloat(v1.replace(',', '.')), n2 = parseFloat(v2.replace(',', '.'));
  if (!isFinite(n1) || !isFinite(n2)) return (calcResult.value = '');
  let res;
  if (currentOp === '+') res = n1 + n2;
  else if (currentOp === '-') res = n1 - n2;
  else if (currentOp === '*') res = n1 * n2;
  else if (currentOp === '/') res = n2 !== 0 ? n1 / n2 : NaN;
  calcResult.value = isFinite(res) ? (Math.round(res * 10000) / 10000).toString().replace('.', ',') : '';
}

calcNum1.oninput = calcUpdate;
calcNum2.oninput = calcUpdate;

saveCalcBtn.onclick = () => {
  const v1 = calcNum1.value.trim(), v2 = calcNum2.value.trim(), result = calcResult.value.trim();
  if (!v1 || !v2 || !result) return;
  const expression = `${v1} ${opSymbol.textContent} ${v2} = ${result}`;
  calcHistoryData.push(expression);
  const item = document.createElement('div');
  item.className = 'history-item';
  item.textContent = expression;
  historyListEl.appendChild(item);
  calcHistoryEl.classList.add('visible');
  saveCalcBtn.style.color = '#4fb84f';
  setTimeout(() => { saveCalcBtn.style.color = ''; }, 300);
};

function clearCalculator() {
  calcNum1.value = calcNum2.value = calcResult.value = '';
}

function makeResultClickable(el) {
  el.onclick = () => {
    const val = el.textContent.trim();
    if (val && val !== '—') {
      calcNum1.value = val;
      calcNum1.focus();
      calcUpdate();
    }
  };
}

document.querySelectorAll('.summary .resline .value').forEach(makeResultClickable);

function num(v) { const n = parseFloat(String(v || '').replace(',', '.')); return isFinite(n) ? n : NaN; }
function fmt(v) { return isFinite(v) ? (Math.round(v * 10000) / 10000).toString().replace('.', ',') : '—'; }

function addRoom() {
  const r = document.createElement('div');
  r.className = 'room';
  r.innerHTML = `
    <div class="row">
      <input class="name" placeholder="Название комнаты">
      <button class="remove" title="Удалить комнату">×</button>
    </div>
    <div class="row inputs">
      <div class="field"><label>Ширина (м)</label><input class="w" inputmode="decimal"></div>
      <div class="field"><label>Длина (м)</label><input class="l" inputmode="decimal"></div>
      <div class="field"><label>Высота (м)</label><input class="h" inputmode="decimal"></div>
    </div>
    <div>
      <div class="row">
        <label>Проёмы</label>
        <button class="btn addOpen">Добавить</button>
        <div style="margin-left:auto;color:var(--muted)">Сумма: <span class="os">—</span></div>
      </div>
      <div class="openings"></div>
    </div>
    <div class="resline"><div>Площадь</div><div class="value ra">—</div></div>
    <div class="resline"><div>Периметр</div><div class="value rp">—</div></div>
    <div class="resline"><div>Стены (без вычета проёмов)</div><div class="value wg">—</div></div>
    <div class="resline"><div>Проёмы</div><div class="value op">—</div></div>
    <div class="resline"><div>Стены (минус проёмы)</div><div class="value wn">—</div></div>
    <div class="resline"><div>Объём</div><div class="value rv">—</div></div>
  `;
  roomsEl.appendChild(r);

  const w = r.querySelector('.w'), l = r.querySelector('.l'), h = r.querySelector('.h');
  const ops = r.querySelector('.openings');
  const removeBtn = r.querySelector('.remove');
  const addOpenBtn = r.querySelector('.addOpen');

  r.querySelectorAll('.resline .value').forEach(makeResultClickable);

  function calc() {
    const W = num(w.value), L = num(l.value), H = num(h.value);
    const A = (isFinite(W) && isFinite(L)) ? W * L : NaN;
    const P = (isFinite(W) && isFinite(L)) ? 2 * (W + L) : NaN;
    let oSum = 0;
    ops.querySelectorAll('.opening').forEach(o => {
      const ow = num(o.querySelector('.ow').value), oh = num(o.querySelector('.oh').value);
      if (isFinite(ow) && isFinite(oh)) oSum += ow * oh;
    });
    const wg = (isFinite(P) && isFinite(H)) ? P * H : NaN;
    const wn = isFinite(wg) ? Math.max(0, wg - oSum) : NaN;
    const V = (isFinite(A) && isFinite(H)) ? A * H : NaN;

    r.querySelector('.ra').textContent = fmt(A);
    r.querySelector('.rp').textContent = fmt(P);
    r.querySelector('.wg').textContent = fmt(wg);
    r.querySelector('.op').textContent = oSum ? fmt(oSum) : '—';
    r.querySelector('.os').textContent = oSum ? fmt(oSum) : '—';
    r.querySelector('.wn').textContent = fmt(wn);
    r.querySelector('.rv').textContent = fmt(V);
    calcTotals();
  }

  addOpenBtn.onclick = () => {
    const o = document.createElement('div');
    o.className = 'opening';
    o.innerHTML = `
      <input class="ow" placeholder="ширина (м)" inputmode="decimal">
      <input class="oh" placeholder="высота (м)" inputmode="decimal">
      <button class="remove" title="Удалить">×</button>
    `;
    ops.appendChild(o);
    o.querySelectorAll('input').forEach(i => i.oninput = calc);
    o.querySelector('.remove').onclick = () => { o.remove(); calc(); };
    calc();
  };

  [w, l, h].forEach(i => i.oninput = calc);
  removeBtn.onclick = () => { r.remove(); calcTotals(); };
  calc();
}

function calcTotals() {
  let A = 0, P = 0, WG = 0, OP = 0, WN = 0, V = 0;
  document.querySelectorAll('.room').forEach(r => {
    const a = num(r.querySelector('.ra').textContent);
    const p = num(r.querySelector('.rp').textContent);
    const wg = num(r.querySelector('.wg').textContent);
    const op = num(r.querySelector('.op').textContent);
    const wn = num(r.querySelector('.wn').textContent);
    const v = num(r.querySelector('.rv').textContent);
    if (isFinite(a)) A += a;
    if (isFinite(p)) P += p;
    if (isFinite(wg)) WG += wg;
    if (isFinite(op)) OP += op;
    if (isFinite(wn)) WN += wn;
    if (isFinite(v)) V += v;
  });
  $('tArea').textContent = fmt(A);
  $('tPer').textContent = fmt(P);
  $('tWallsGross').textContent = fmt(WG);
  $('tOpenings').textContent = fmt(OP);
  $('tWallsNet').textContent = fmt(WN);
  $('tVol').textContent = fmt(V);
}

function buildExportText() {
  const lines = [];
  document.querySelectorAll('.room').forEach((r, idx) => {
    const name = r.querySelector('.name').value.trim() || `Комната ${idx + 1}`;
    lines.push(`${name}:`);
    lines.push(`  Ширина: ${r.querySelector('.w').value || '—'} м`);
    lines.push(`  Длина: ${r.querySelector('.l').value || '—'} м`);
    lines.push(`  Высота: ${r.querySelector('.h').value || '—'} м`);
    lines.push(`  Площадь: ${r.querySelector('.ra').textContent} м²`);
    lines.push(`  Периметр: ${r.querySelector('.rp').textContent} м`);
    lines.push(`  Стены (без вычета): ${r.querySelector('.wg').textContent} м²`);
    lines.push(`  Проёмы: ${r.querySelector('.op').textContent} м²`);
    lines.push(`  Стены (минус проёмы): ${r.querySelector('.wn').textContent} м²`);
    lines.push(`  Объём: ${r.querySelector('.rv').textContent} м³`);
    const opens = r.querySelectorAll('.opening');
    if (opens.length) {
      lines.push('  Проёмы:');
      opens.forEach((o, i) => {
        lines.push(`    ${i + 1}) ${o.querySelector('.ow').value || '—'} × ${o.querySelector('.oh').value || '—'} м`);
      });
    }
    lines.push('');
  });
  lines.push('ИТОГО:');
  lines.push(`  Общая площадь: ${$('tArea').textContent} м²`);
  lines.push(`  Общий периметр: ${$('tPer').textContent} м`);
  lines.push(`  Стены (без вычета): ${$('tWallsGross').textContent} м²`);
  lines.push(`  Сумма проёмов: ${$('tOpenings').textContent} м²`);
  lines.push(`  Стены (минус проёмы): ${$('tWallsNet').textContent} м²`);
  lines.push(`  Общий объём: ${$('tVol').textContent} м³`);
  if (calcHistoryData.length) {
    lines.push('\nИСТОРИЯ РАСЧЁТОВ:');
    calcHistoryData.forEach((expr, i) => lines.push(`  ${i + 1}) ${expr}`));
  }
  return lines.join('\n');
}

function showShareModal(text) {
  modalRoot.innerHTML = '';
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div style="font-weight:600;margin-bottom:8px">Экспорт результата</div>
    <textarea readonly>${text}</textarea>
    <div class="mrow">
      <button class="btn copyBtn">Копировать</button>
      <button class="btn closeBtn">Закрыть</button>
    </div>
  `;
  modalRoot.appendChild(backdrop);
  backdrop.appendChild(modal);
  modal.querySelector('.copyBtn').onclick = () => {
    const ta = modal.querySelector('textarea');
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(ta.value).then(() => {
        modal.querySelector('.copyBtn').textContent = '✓ Скопировано';
        setTimeout(() => modal.querySelector('.copyBtn').textContent = 'Копировать', 1500);
      });
    } else {
      ta.select();
      document.execCommand('copy');
      modal.querySelector('.copyBtn').textContent = '✓ Скопировано';
      setTimeout(() => modal.querySelector('.copyBtn').textContent = 'Копировать', 1500);
    }
  };
  modal.querySelector('.closeBtn').onclick = () => { modalRoot.innerHTML = ''; };
}

$('shareBtn').onclick = () => {
  const text = buildExportText();
  if (window.Telegram?.WebApp) {
    Telegram.WebApp.sendData(text);
  } else {
    showShareModal(text);
  }
};

$('addRoom').onclick = addRoom;
$('clearAll').onclick = () => {
  roomsEl.innerHTML = '';
  calcTotals();
  clearCalculator();
  calcHistoryData = [];
  historyListEl.innerHTML = '';
  calcHistoryEl.classList.remove('visible');
};

// Автозапуск первой комнаты
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', addRoom);
} else {
  addRoom();
}
</script>

